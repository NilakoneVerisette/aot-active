<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Storage Event</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 8px; }
    .sub { color: #666; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f6f6f6; text-align: left; }
    tr:nth-child(even) { background: #fafafa; }
    .status { font-weight: 600; padding: 2px 6px; border-radius: 4px; display: inline-block; }
    .RED { background: #ffe5e5; color: #b00020; }
    .YELLOW { background: #fff7e0; color: #8a6d00; }
    .GREEN { background: #e7f7eb; color: #0f7b24; }
    .muted { color: #888; font-size: 12px; }
    .refresh-indicator { 
      display: inline-block; 
      margin-left: 8px; 
      color: #0066cc; 
      font-size: 12px; 
      animation: pulse 2s infinite; 
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>Storage Event<span class="refresh-indicator" id="refreshIndicator">●</span></h1>
  <div style="margin: 8px 0 16px;">
    <a href="/api/service/device_reader_loss/view">Go to Device Reader Loss →</a>
  </div>
  <div class="sub">Datetime: <strong id="datetime"><%= data && data.datetime ? data.datetime : '-' %></strong></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Location</th>
        <th>Description</th>
        <th>Trolley Type</th>
        <th>Type Desc</th>
        <th>Max</th>
        <th>Normal</th>
        <th>Min</th>
        <th>Current</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <% if (data && Array.isArray(data.locations) && data.locations.length) { %>
        <% data.locations.forEach(function(item, idx) { %>
          <tr>
            <td><%= idx + 1 %></td>
            <td><%= item.location ?? '' %></td>
            <td><%= item.location_desc ?? '' %></td>
            <td><%= item.trolley_type ?? '' %></td>
            <td><%= item.type_desc ?? '' %></td>
            <td><%= item.max_qty ?? '' %></td>
            <td><%= item.normal_qty ?? '' %></td>
            <td><%= item.min_qty ?? '' %></td>
            <td><%= item.current_qty ?? '' %></td>
            <td>
              <% const status = (item.current_status || '').toUpperCase(); %>
              <span class="status <%= status %>"><%= status || '-' %></span>
            </td>
          </tr>
        <% }); %>
      <% } else { %>
        <tr>
          <td colspan="10" class="muted">No locations provided.</td>
        </tr>
      <% } %>
    </tbody>
  </table>

  <script>
    // Auto-refresh functionality
    const REFRESH_INTERVAL = 5000; // 5 seconds
    let lastDatetime = '<%= data && data.datetime ? data.datetime : "" %>';

    async function fetchAndUpdate() {
      try {
        const response = await fetch('/api/service/storage_event');
        if (!response.ok) throw new Error('Failed to fetch');
        
        const newData = await response.json();
        
        // Check if data has changed
        if (newData.datetime && newData.datetime !== lastDatetime) {
          lastDatetime = newData.datetime;
          updatePage(newData);
        }
      } catch (error) {
        console.error('Error fetching storage event:', error);
      }
    }

    function updatePage(data) {
      // Update datetime
      const datetimeEl = document.getElementById('datetime');
      if (datetimeEl) {
        datetimeEl.textContent = data.datetime || '-';
      }

      // Update table body
      const tbody = document.querySelector('tbody');
      if (!tbody) return;

      if (data.locations && Array.isArray(data.locations) && data.locations.length > 0) {
        tbody.innerHTML = data.locations.map((item, idx) => {
          const status = (item.current_status || '').toUpperCase();
          return `
            <tr>
              <td>${idx + 1}</td>
              <td>${item.location ?? ''}</td>
              <td>${item.location_desc ?? ''}</td>
              <td>${item.trolley_type ?? ''}</td>
              <td>${item.type_desc ?? ''}</td>
              <td>${item.max_qty ?? ''}</td>
              <td>${item.normal_qty ?? ''}</td>
              <td>${item.min_qty ?? ''}</td>
              <td>${item.current_qty ?? ''}</td>
              <td>
                <span class="status ${status}">${status || '-'}</span>
              </td>
            </tr>
          `;
        }).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="10" class="muted">No locations provided.</td></tr>';
      }

      // Flash the refresh indicator
      const indicator = document.getElementById('refreshIndicator');
      if (indicator) {
        indicator.style.color = '#00cc00';
        setTimeout(() => {
          indicator.style.color = '#0066cc';
        }, 300);
      }
    }

    // Start auto-refresh
    setInterval(fetchAndUpdate, REFRESH_INTERVAL);
    console.log('Auto-refresh enabled: checking for updates every', REFRESH_INTERVAL / 1000, 'seconds');
  </script>
</body>
</html>
